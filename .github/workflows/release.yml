---
name: 🔖 Release (SemVer) → 📄 MkDocs → 🚀 Pages

on:
  workflow_run:
    workflows:
      - '⚙️ ESPHome CI'
    types: [completed]

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

concurrency:
  group: release-pages
  cancel-in-progress: true

jobs:
  preview_any_branch:
    name: 🔍 Preview Release Steps
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.repository == 'saya6k/home-assistant-config'
    runs-on: ubuntu-latest
    steps:
      - name: ⤵️ Checkout at triggering SHA
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: 🔧 Setup Node (for semantic-release)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: 🧪 Install deps if present (optional)
        run: |
          if [ -f package-lock.json ] || [ -f package.json ]; then
            npm ci
          fi

      - name: 🚀 Run semantic-release (dry run)
        id: semantic_dry_run
        run: |
          npx semantic-release --dry-run \
            --extra-plugins \
              conventional-changelog-conventionalcommits \
              @semantic-release/commit-analyzer \
              @semantic-release/release-notes-generator \
              @semantic-release/changelog \
              @semantic-release/git \
              @semantic-release/github

      - name: 📄 Show Dry Run Result
        run: |
          echo "Semantic Release Dry Run Result" && \
          echo ${{ steps.semantic_dry_run.outputs }}

  release:
    name: 🔖 Release (SemVer)
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main' &&
      github.repository == 'saya6k/home-assistant-config'
    runs-on: ubuntu-latest
    outputs:
      published: ${{ steps.release.outputs.new_release_published }}
      version: ${{ steps.release.outputs.new_release_version }}

    steps:
      - name: ⤵️ Checkout at triggering SHA
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: 🔧 Setup Node (for semantic-release)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: 🧪 Install deps if present (optional)
        run: |
          if [ -f package-lock.json ] || [ -f package.json ]; then
            npm ci
          fi

      - name: 🚀 Run semantic-release (tags, GitHub Release, CHANGELOG)
        id: release
        uses: cycjimmy/semantic-release-action@v4
        with:
          branch: main
          extra_plugins: |
            conventional-changelog-conventionalcommits
            @semantic-release/commit-analyzer
            @semantic-release/release-notes-generator
            @semantic-release/changelog
            @semantic-release/git
            @semantic-release/github
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: 📝 Summary
        run: |
          echo "published=${{ steps.release.outputs.new_release_published }}" >> $GITHUB_STEP_SUMMARY
          echo "version=${{ steps.release.outputs.new_release_version }}" >> $GITHUB_STEP_SUMMARY

  mkdocs_deploy:
    name: 📄 Build and 🚀 Deploy MkDocs (on release)
    needs: release
    if: needs.release.outputs.published == 'true'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ⤵️ Check out mkdocs source
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: 📦 Install dependencies
        run: pip install -r requirements.txt

      - name: 🏗️ Build MkDocs site
        run: mkdocs build --config-file mkdocs.yml --site-dir site

      - name: 📤 Upload site artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: 🚀 Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
