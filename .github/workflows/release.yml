---
name: ğŸ”– Release (SemVer) â†’ ğŸ“„ MkDocs â†’ ğŸš€ Pages

on:
  workflow_run:
    workflows:
      - 'ğŸª„ Refresh Repository Badges'
      - 'ğŸ  Home Assistant CI'
      - 'ğŸ§¹âœ¨ Linting & Style Checks'
    types: [completed]
    branches: [main]

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

concurrency:
  group: release-pages
  cancel-in-progress: true

jobs:
  release:
    # íŠ¸ë¦¬ê±°ëœ ì›Œí¬í”Œë¡œìš°ê°€ ì„±ê³µì´ê³ , ëŒ€ìƒ ë¸Œëœì¹˜ê°€ mainì¼ ë•Œë§Œ
    if: >
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.head_branch == 'main'
      }}
    runs-on: ubuntu-latest
    outputs:
      published: ${{ steps.release.outputs.new_release_published }}
      version: ${{ steps.release.outputs.new_release_version }}

    steps:
      - name: â¤µï¸ Checkout at triggering SHA
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: âœ… Wait until all required workflows succeeded for this SHA
        uses: actions/github-script@v7
        with:
          script: |
            const required = [
              "ğŸª„ Refresh Repository Badges",
              "ğŸ  Home Assistant CI",
              "ğŸ§¹âœ¨ Linting & Style Checks",
            ];
            const { owner, repo } = context.repo;
            const sha = context.payload.workflow_run.head_sha;

            const timeoutMs = 20 * 60 * 1000; // ìµœëŒ€ 20ë¶„ ëŒ€ê¸°
            const intervalMs = 15000;         // 15ì´ˆë§ˆë‹¤ ì²´í¬
            const start = Date.now();

            async function allSucceeded() {
              const runs = await github.paginate(
                github.rest.actions.listWorkflowRunsForRepo,
                { owner, repo, head_sha: sha, per_page: 100 }
              );
              const ok = new Set();
              for (const r of runs) {
                if (required.includes(r.name) &&
                    r.head_branch === "main" &&
                    r.conclusion === "success") {
                  ok.add(r.name);
                }
              }
              const missing = required.filter(n => !ok.has(n));
              return { done: missing.length === 0, missing };
            }

            while (true) {
              const { done, missing } = await allSucceeded();
              if (done) {
                core.info("All required workflows succeeded.");
                break;
              }
              if (Date.now() - start > timeoutMs) {
                core.setFailed(`Timed out waiting for workflows: ${missing.join(", ")}`);
                break;
              }
              core.info(`Waiting for: ${missing.join(", ")} ...`);
              await new Promise(r => setTimeout(r, intervalMs));
            }

      - name: ğŸ”§ Setup Node (for semantic-release)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ§ª Install deps if present (optional)
        run: |
          if [ -f package-lock.json ] || [ -f package.json ]; then
            npm ci
          fi

      - name: ğŸš€ Run semantic-release (tags, GitHub Release, CHANGELOG)
        id: release
        uses: cycjimmy/semantic-release-action@v4
        with:
          branch: main
          extra_plugins: |
            conventional-changelog-conventionalcommits
            @semantic-release/commit-analyzer
            @semantic-release/release-notes-generator
            @semantic-release/changelog
            @semantic-release/git
            @semantic-release/github
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: ğŸ“ Summary
        run: |
          echo "published=${{ steps.release.outputs.new_release_published }}" >> $GITHUB_STEP_SUMMARY
          echo "version=${{ steps.release.outputs.new_release_version }}" >> $GITHUB_STEP_SUMMARY

  mkdocs_deploy:
    name: ğŸ“„ Build and ğŸš€ Deploy MkDocs (on release)
    needs: release
    if: needs.release.outputs.published == 'true'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # ê¸°ì¡´ PRìš© ì›Œí¬í”Œë¡œìš°ì™€ ë™ì¼í•˜ê²Œ gh-deploy ë¸Œëœì¹˜ë¥¼ ì†ŒìŠ¤ë¡œ ì‚¬ìš©
      - name: â¤µï¸ Check out mkdocs source (gh-deploy)
        uses: actions/checkout@v5
        with:
          ref: gh-deploy

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: ğŸ“¦ Install dependencies
        run: pip install -r requirements.txt

      - name: ğŸ—ï¸ Build MkDocs site
        run: mkdocs build --config-file mkdocs.yml --site-dir site

      - name: ğŸ“¤ Upload site artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
